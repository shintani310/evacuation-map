<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¿é›£æ‰€ãƒãƒƒãƒ—</title>
</head>
<body>
    <h1>é¿é›£æ‰€ãƒãƒƒãƒ—</h1>
    <p>æœ€å¯„ã‚Šã®é¿é›£æ‰€ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’Googleãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã§é–‹ãã¾ã™ã€‚</p>
    
    <button onclick="openGoogleMaps()">Googleãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã§é–‹ã</button>

    <script>
        function openGoogleMaps() {
            fetch('/evacuation-map/shelters.json')
                .then(response => response.json())
                .then(shelters => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const userLocation = `${position.coords.latitude},${position.coords.longitude}`;

                            findNearestShelter(userLocation, shelters)
                                .then(nearestShelter => {
                                    if (!nearestShelter) {
                                        alert("æœ€å¯„ã‚Šã®é¿é›£æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                                        return;
                                    }
                                    const googleMapsURL = generateGoogleMapsURL(userLocation, nearestShelter, shelters);
                                    window.location.href = googleMapsURL;
                                });
                        });
                    } else {
                        alert("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                    }
                });
        }

        function findNearestShelter(userLocation, shelters) {
            return new Promise((resolve) => {
                let nearestShelter = null;
                let shortestRouteDistance = Infinity;

                const directionsService = new google.maps.DirectionsService();
                let pendingRequests = shelters.length;

                shelters.forEach(shelter => {
                    const request = {
                        origin: userLocation,
                        destination: `${shelter.lat},${shelter.lng}`,
                        travelMode: google.maps.TravelMode.DRIVING,
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            const routeDistance = result.routes[0].legs[0].distance.value;
                            if (routeDistance < shortestRouteDistance) {
                                shortestRouteDistance = routeDistance;
                                nearestShelter = shelter;
                            }
                        }
                        pendingRequests--;

                        if (pendingRequests === 0) {
                            resolve(nearestShelter);
                        }
                    });
                });
            });
        }

        function generateGoogleMapsURL(userLocation, nearestShelter, shelters) {
            const destination = `${nearestShelter.lat},${nearestShelter.lng}`;
            const waypoints = shelters.map(shelter => `${shelter.lat},${shelter.lng}`).join("|");

            return `comgooglemaps://?api=1&origin=${userLocation}&destination=${destination}&waypoints=${waypoints}&travelmode=driving`;
        }
    </script>

    <!-- ğŸ”¹ APIã‚­ãƒ¼ã‚’å«ã‚€ Google Maps API ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzeYjQKEEkRqOPTmWZmZFT4jIHY1Vpjxk&libraries=geometry"></script>
</body>
</html>
