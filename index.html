<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>避難所マップ</title>
  <style>
    /* 画面全体にマップを表示 */
    #map {
      height: 100vh;
      width: 100%;
    }
    /* 情報ウィンドウ内のボタンサイズ調整（任意） */
    .info-window button {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Google マップを表示する領域 -->
  <div id="map"></div>

  <script>
    // グローバル変数
    let map;
    let userLocation;     // { lat: 数値, lng: 数値 }
    let shelters = [];    // JSONから読み込んだ避難所データ
    let markers = [];     // 各避難所のマーカー
    let infoWindow;       // 現在開いている情報ウィンドウ
    let nearestShelter;   // 最短到着の避難所データ
    let nearestMarker;    // 対応するマーカー

    // ページ読み込み時に自動実行
    window.addEventListener('load', initMap);

    // マップ初期化と処理開始
    function initMap() {
      // 初期表示用に適当な中心点を設定
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 35, lng: 139 },
        zoom: 12
      });
      
      // JSON から避難所データを取得
      fetch('shelters.json')
        .then(response => response.json())
        .then(data => {
          shelters = data;
          // ユーザーの現在地取得
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              // ユーザー位置を中心にマップ再設定
              map.setCenter(userLocation);
              // ユーザーの現在地マーカー（青い円）
              new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: "#4285F4",
                  fillOpacity: 1,
                  strokeWeight: 2,
                  strokeColor: "#ffffff"
                },
                title: "現在地"
              });
              // 避難所の各位置にマーカー配置
              shelters.forEach(shelter => {
                const pos = { lat: shelter.lat, lng: shelter.lng };
                const marker = new google.maps.Marker({
                  position: pos,
                  map: map,
                  title: shelter.name
                });
                // マーカーに避難所データを関連付ける
                marker.shelterData = shelter;
                markers.push(marker);
                // マーカーをタップしたときは、その情報ウィンドウを開く
                marker.addListener('click', () => {
                  openInfoWindow(marker);
                });
              });
              // すべてのマーカー配置完了後、最短（到着時間最小）の避難所を決定
              determineNearestShelter();
            }, () => {
              alert("位置情報が取得できませんでした。");
            });
          } else {
            alert("このブラウザは位置情報に対応していません。");
          }
        })
        .catch(error => {
          console.error("避難所データの取得エラー:", error);
        });
    }

    // 指定したマーカーの情報ウィンドウを開く
    function openInfoWindow(marker) {
      if (infoWindow) { infoWindow.close(); }
      const shelter = marker.shelterData;
      // 情報ウィンドウ内にナビ開始ボタンを設置
      const content = `
        <div class="info-window">
          <strong>${shelter.name}</strong><br>
          ${shelter.address}<br>
          <button id="navButton">ナビ開始</button>
        </div>
      `;
      infoWindow = new google.maps.InfoWindow({
        content: content
      });
      infoWindow.open(map, marker);
      // DOM生成後にボタンのクリックイベントを設定
      google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
        document.getElementById('navButton').addEventListener('click', () => {
          launchNavigation(marker.position);
        });
      });
    }

    // ネイティブの Google Maps アプリを起動してナビ開始（URLスキーム）
    function launchNavigation(destination) {
      const originStr = `${userLocation.lat},${userLocation.lng}`;
      const destStr = `${destination.lat()},${destination.lng()}`;
      const url = `comgooglemaps://?saddr=${originStr}&daddr=${destStr}&directionsmode=driving`;
      window.location.href = url;
    }

    // DirectionsService を利用して各避難所への運転時間を計算し、
    // 最も到着時間が短い避難所を決定、そのマーカーの情報ウィンドウを自動で開く
    function determineNearestShelter() {
      const directionsService = new google.maps.DirectionsService();
      let processed = 0;
      let bestDuration = Infinity;
      shelters.forEach(shelter => {
        const request = {
          origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
          destination: new google.maps.LatLng(shelter.lat, shelter.lng),
          travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, (result, status) => {
          processed++;
          if (status === google.maps.DirectionsStatus.OK) {
            const duration = result.routes[0].legs[0].duration.value; // 秒単位
            if (duration < bestDuration) {
              bestDuration = duration;
              nearestShelter = shelter;
              // 対応するマーカーを検索
              nearestMarker = markers.find(m =>
                m.shelterData.lat === shelter.lat && m.shelterData.lng === shelter.lng
              );
            }
          }
          // すべての避難所について評価が完了したら、最短の避難所マーカーの情報ウィンドウを開く
          if (processed === shelters.length && nearestMarker) {
            openInfoWindow(nearestMarker);
            // ※自動でナビ開始させたい場合は、下記のコメントを外してください。
            // setTimeout(() => {
            //   launchNavigation(nearestMarker.position);
            // }, 2000);
          }
        });
      });
    }
  </script>
  <!-- Google Maps API 読み込み（API キーを設定してください） -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzeYjQKEEkRqOPTmWZmZFT4jIHY1Vpjxk"></script>
</body>
</html>

