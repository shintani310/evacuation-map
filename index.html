<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>避難所マップ</title>
</head>
<body>
    <h1>避難所マップ</h1>
    <p>最寄りの避難所へのルートをGoogleマップアプリで開きます。</p>
    
    <button onclick="openGoogleMaps()">Googleマップアプリで開く</button>

    <script>
        function openGoogleMaps() {
            console.log("JSON データを読み込みます...");

            fetch('/evacuation-map/shelters.json')
                .then(response => response.json())
                .then(shelters => {
                    console.log("避難所データ:", shelters);

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const userLocation = `${position.coords.latitude},${position.coords.longitude}`;
                            console.log("現在地:", userLocation);

                            findNearestShelter(userLocation, shelters)
                                .then(nearestShelter => {
                                    if (!nearestShelter) {
                                        alert("最寄りの避難所が見つかりませんでした。");
                                        return;
                                    }
                                    const googleMapsURL = generateGoogleMapsURL(userLocation, nearestShelter, shelters);
                                    console.log("Google マップの URL:", googleMapsURL);
                                    window.location.href = googleMapsURL;
                                });
                        });
                    } else {
                        alert("位置情報が利用できません。");
                    }
                })
                .catch(error => {
                    console.error("JSON の読み込みに失敗:", error);
                });
        }

        function findNearestShelter(userLocation, shelters) {
            return new Promise((resolve) => {
                let nearestShelter = null;
                let shortestRouteDistance = Infinity;

                const directionsService = new google.maps.DirectionsService();
                let pendingRequests = shelters.length;

                shelters.forEach(shelter => {
                    const request = {
                        origin: userLocation,
                        destination: `${shelter.lat},${shelter.lng}`,
                        travelMode: google.maps.TravelMode.DRIVING,
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            const routeDistance = result.routes[0].legs[0].distance.value;
                            if (routeDistance < shortestRouteDistance) {
                                shortestRouteDistance = routeDistance;
                                nearestShelter = shelter;
                            }
                        }
                        pendingRequests--;

                        if (pendingRequests === 0) {
                            resolve(nearestShelter);
                        }
                    });
                });
            });
        }

        function generateGoogleMapsURL(userLocation, nearestShelter, shelters) {
            const destination = `${nearestShelter.lat},${nearestShelter.lng}`;

            // **避難所データが有効なら Google マップに渡す**
            if (!shelters || shelters.length === 0) {
                console.error("避難所データが空です！");
                return `comgooglemaps://?api=1&origin=${userLocation}&destination=${destination}&travelmode=driving`;
            }

            // **全避難所をピンとして表示するための `waypoints` を追加**
            const waypoints = shelters
                .map(shelter => `${shelter.lat},${shelter.lng}`)
                .join("|");

            return `comgooglemaps://?api=1&origin=${userLocation}&destination=${destination}&waypoints=${waypoints}&travelmode=driving`;
        }
    </script>

    <!-- Google Maps API 読み込み -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzeYjQKEEkRqOPTmWZmZFT4jIHY1Vpjxk&libraries=geometry"></script>
</body>
</html>
