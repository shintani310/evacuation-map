<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅøÈõ£ÊâÄ„Éû„ÉÉ„Éó</title>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Google Maps API „Çπ„ÇØ„É™„Éó„Éà„ÇíË™≠„ÅøËæº„ÇÄ -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzeYjQKEEkRqOPTmWZmZFT4jIHY1Vpjxk&callback=initMap">
    </script>

    <script>
        function initMap() {
            console.log("Google Maps API„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü");
            const center = { lat: 33.6, lng: 134.3 }; // Âú∞Âõ≥„ÅÆÂàùÊúü‰∏≠ÂøÉ‰ΩçÁΩÆ
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: center,
            });

            fetch('/evacuation-map/shelters.json')
                .then(response => {
                    console.log("„É¨„Çπ„Éù„É≥„Çπ„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü", response);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("JSON„Éá„Éº„Çø:", data);

                    data.forEach(shelter => {
                        const marker = new google.maps.Marker({
                            position: { lat: shelter.lat, lng: shelter.lng },
                            map: map,
                            title: shelter.name,
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h3>${shelter.name}</h3><p>${shelter.address}</p>`,
                        });

                        marker.addListener("click", () => {
                            infoWindow.open(map, marker);
                        });
                    });
                })
                .catch(error => {
                    console.error("JSON„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:", error);
                });
        }
    </script>
    <script>
        function initMap(shelters) {
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: { lat: 33.6, lng: 134.3 }, // ÂàùÊúü‰ΩçÁΩÆÔºàÂæå„ÅßÁèæÂú®Âú∞„Å´Â§âÊõ¥Ôºâ
            });
    
            // üîπ ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åô„Çã
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        console.log("ÁèæÂú®Âú∞:", userLocation);
    
                        // üîπ ÁèæÂú®Âú∞„Å´„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: "ÁèæÂú®Âú∞",
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                            },
                        });
    
                        // üîπ ÁèæÂú®Âú∞„ÇíÂú∞Âõ≥„ÅÆ‰∏≠ÂøÉ„Å´Ë®≠ÂÆö
                        map.setCenter(userLocation);
                    },
                    () => {
                        console.error("‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    }
                );
            } else {
                console.error("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì");
            }
    
            // üîπ ÈÅøÈõ£ÊâÄ„ÅÆ„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
            shelters.forEach(shelter => {
                const marker = new google.maps.Marker({
                    position: { lat: shelter.lat, lng: shelter.lng },
                    map: map,
                    title: shelter.name,
                });
    
                const infoWindow = new google.maps.InfoWindow({
                    content: `<h3>${shelter.name}</h3><p>${shelter.address}</p>`,
                });
    
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>  
    <script>
    function findNearestShelter(userLocation, shelters) {
        let nearestShelter = null;
        let shortestDistance = Infinity;

        shelters.forEach(shelter => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(userLocation.lat, userLocation.lng),
                new google.maps.LatLng(shelter.lat, shelter.lng)
            );

            if (distance < shortestDistance) {
                shortestDistance = distance;
                nearestShelter = shelter;
            }
        });

        return nearestShelter;
    }

    function showRoute(userLocation, nearestShelter, map) {
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        const request = {
            origin: userLocation,
            destination: { lat: nearestShelter.lat, lng: nearestShelter.lng },
            travelMode: google.maps.TravelMode.WALKING, // ÂæíÊ≠©„É´„Éº„Éà
        };

        directionsService.route(request, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            } else {
                console.error("„É´„Éº„Éà„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", status);
            }
        });
    }

    function initMap(shelters) {
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: { lat: 33.6, lng: 134.3 },
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    console.log("ÁèæÂú®Âú∞:", userLocation);

                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "ÁèæÂú®Âú∞",
                        icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        },
                    });

                    map.setCenter(userLocation);

                    const nearestShelter = findNearestShelter(userLocation, shelters);
                    if (nearestShelter) {
                        showRoute(userLocation, nearestShelter, map);
                    }
                },
                () => {
                    console.error("‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                }
            );
        } else {
            console.error("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì");
        }

        shelters.forEach(shelter => {
            const marker = new google.maps.Marker({
                position: { lat: shelter.lat, lng: shelter.lng },
                map: map,
                title: shelter.name,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${shelter.name}</h3><p>${shelter.address}</p>`,
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
        });
    }
</script>
</body>
</html>
